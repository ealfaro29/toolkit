<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miniapp: búsqueda secuencial de logos</title>

  <style>
    :root { --gap: 1rem; --bg: #f7f7f8; --card: #ffffff; --border: #e6e6ea; }
    * { box-sizing: border-box; }
    body { margin: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: #111; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 1.1rem; margin: 0 0 12px; }
    h2 { font-size: 1rem; margin: 16px 0 8px; }

    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .controls { display: grid; grid-template-columns: 1fr 220px; gap: 12px; align-items: start; }
    textarea { width: 100%; min-height: 110px; padding: 8px; resize: vertical; border: 1px solid var(--border); border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: #0f62fe; color: #fff; cursor: pointer; font-weight: 600; }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .status { font-size: .9rem; color: #333; margin-top: 6px; }
    .keytip { font-size: .85rem; color: #666; }

    .gcse-search { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 8px; }

    #coleccion { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
    .masonry { columns: 220px 4; column-gap: var(--gap); }
    .masonry .tile { break-inside: avoid; margin: 0 0 var(--gap); position: relative; }
    .masonry img { width: 100%; display: block; border-radius: 6px; border: 2px solid #f0f0f3; transition: transform .15s ease; }
    .masonry img:hover { transform: scale(1.03); }
    .remove {
      position: absolute; top: 6px; right: 6px;
      background: rgba(0,0,0,.72); color: #fff; border: 0; border-radius: 14px;
      padding: 2px 8px; font-size: .75rem; cursor: pointer;
    }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #243bff; font-size: .8rem; font-weight: 600; }
  </style>

  <script>
    // Estado del flujo
    let cola = [];
    let idx = -1;
    let cseReady = false;
    let cseEl = null; // instancia del elemento CSE (search combinado)

    // Interceptar clics en resultados de imagen para agregar y avanzar
    function resultadosImagenListos() {
      const resultados = document.querySelectorAll('.gsc-imageResult');
      resultados.forEach(res => {
        const img = res.querySelector('img');
        if (!img) return;
        res.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          agregarImagenAColeccion(img.src);
          avanzar();
          return false;
        };
      });
    }

    // Registrar callbacks antes de cargar el script CSE
    window.__gcse = {
      callback: function() {
        // Obtener el elemento "search" combinado por su gname
        try {
          cseEl = google.search.cse.element.getElement('logos');
        } catch (e) {
          cseEl = null;
        }
        cseReady = !!cseEl;
        actualizarEstado();
      },
      searchCallbacks: {
        image: { rendered: resultadosImagenListos }
      }
    };

    // Utilidades de UI
    function parsearLista() {
      const raw = document.getElementById('lista').value || '';
      return raw.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
    }

    function actualizarEstado() {
      const total = cola.length;
      const pos = idx >= 0 && idx < total ? (idx + 1) : 0;
      const actual = idx >= 0 && idx < total ? cola[idx] : '';
      document.getElementById('progreso').textContent = total ? `${pos} de ${total}` : '0 de 0';
      document.getElementById('actual').textContent = actual || '—';
      const enCurso = total > 0 && idx >= 0 && idx < total;
      document.getElementById('btnOmitir').disabled = !enCurso;
      document.getElementById('btnReintentar').disabled = !enCurso || !cseReady;
      document.getElementById('btnIniciar').disabled = !cseReady;
    }

    function ejecutarBusqueda(termino) {
      if (!cseReady || !cseEl) return;
      cseEl.execute(termino);
    }

    function avanzar() {
      if (!cola.length) return;
      idx++;
      if (idx >= cola.length) {
        idx = cola.length; // fin
        actualizarEstado();
        return;
      }
      actualizarEstado();
      ejecutarBusqueda(cola[idx]);
    }

    function iniciar() {
      cola = parsearLista();
      idx = -1;
      avanzar();
    }

    function reintentar() {
      if (idx < 0 || idx >= cola.length) return;
      ejecutarBusqueda(cola[idx]);
    }

    function omitir() {
      if (idx < 0 || idx >= cola.length) return;
      idx++;
      if (idx >= cola.length) {
        idx = cola.length;
        actualizarEstado();
        return;
      }
      actualizarEstado();
      ejecutarBusqueda(cola[idx]);
    }

    // Colección
    function agregarImagenAColeccion(url) {
      if (!url) return;
      const cont = document.getElementById('coleccion');
      const tile = document.createElement('div');
      tile.className = 'tile';

      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Logo seleccionado';

      const btn = document.createElement('button');
      btn.className = 'remove';
      btn.type = 'button';
      btn.textContent = 'Quitar';
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        tile.remove();
      });

      tile.appendChild(img);
      tile.appendChild(btn);
      cont.appendChild(tile);
    }
  </script>

  <!-- Cargar Google Programmable Search con tu cx -->
  <script async src="https://cse.google.com/cse.js?cx=f06634081a8cb43ba"></script>
</head>
<body>
  <div class="wrap">
    <h1>Flujo secuencial de logos</h1>

    <div class="panel controls">
      <textarea id="lista" placeholder="Pega términos separados por coma o por líneas&#10;Ejemplos:&#10;Nike, Adidas, Starbucks&#10;Apple&#10;Microsoft&#10;OpenAI"></textarea>
      <div>
        <div class="btns">
          <button id="btnIniciar" type="button" onclick="iniciar()" disabled>Iniciar</button>
          <button id="btnReintentar" class="secondary" type="button" onclick="reintentar()" disabled>Reintentar</button>
          <button id="btnOmitir" class="secondary" type="button" onclick="omitir()" disabled>Omitir</button>
        </div>
        <div class="status">
          Progreso: <span id="progreso" class="pill">0 de 0</span><br />
          Actual: <span id="actual">—</span>
        </div>
        <div class="keytip">Haz clic en cualquier imagen de los resultados para agregarla y avanzar al siguiente término.</div>
      </div>
    </div>

    <!-- Elemento combinado: caja + resultados, con el mismo gname -->
    <div class="panel">
      <div class="gcse-search"
           data-gname="logos"
           data-defaultToImageSearch="true"
           data-disableWebSearch="true"></div>
    </div>

    <h2>Mi colección</h2>
    <div id="coleccion" class="panel masonry" aria-live="polite"></div>
  </div>
</body>
</html>
