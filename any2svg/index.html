<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Any2SVG</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg" />

  <link rel="stylesheet" href="../shared/styles.css" />
  <style>
    /* === ANY2SVG-SPECIFIC STYLES === */

    /* Header spans full width */
    header.panel {
      grid-column: 1 / -1;
    }

    /* Canvas preview styles */
    canvas#preview {
      max-width: 100%;
      max-height: 100%;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius-md);
      background: var(--surface)
    }

    .placeholder {
      color: var(--muted);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-4);
    }

    /* Loading spinner */
    .loader-svg {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Toast notification */
    .toast-notification {
      position: absolute;
      bottom: var(--space-5);
      left: 50%;
      transform: translate(-50%, 20px);
      background-color: var(--accent-color);
      color: var(--color-accent-text);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-floating-3);
      font-weight: var(--font-weight-medium);
      opacity: 0;
      visibility: hidden;
      transition: all var(--duration-standard) ease;
      z-index: 10;
      pointer-events: none;
    }

    .toast-notification.show {
      transform: translate(-50%, 0);
      opacity: 1;
      visibility: visible;
    }

    /* Wiki header background */
    .wiki-header {
      background-image: url('modal.png');
    }

    /* Progress bar for engine loading */
    .splash-progress {
      margin-top: var(--space-4);
      width: 100%;
    }

    #splash-progress-text {
      font-size: var(--font-size-caption);
      color: var(--muted);
      margin-bottom: var(--space-2);
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: var(--surface);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-inner {
      width: 0%;
      height: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    /* Error styling */
    .error-note {
      color: var(--danger-color) !important;
      font-weight: var(--font-weight-medium);
    }

    /* Floating visitor badge */
    .floating-visitor-badge {
      position: fixed;
      bottom: var(--space-3, 12px);
      right: var(--space-3, 12px);
      z-index: 1000;
      opacity: 0.6;
      transition: opacity var(--duration-standard) ease;
      transform: scale(0.8);
      transform-origin: bottom right;
    }

    .floating-visitor-badge:hover {
      opacity: 1;
    }
  </style>
</head>

<body>

  <div class="splash-overlay" id="splash-screen">
    <div class="splash-content">
      <button id="splash-close-btn" title="Close" disabled>&times;</button>
      <div class="splash-info">
        <span class="splash-icon">ðŸª„</span>
        <h2 class="splash-title">Any2SVG</h2>
        <p class="splash-tech">Utilizes a powerful client-side engine to process files directly in your browser for
          maximum speed and privacy.</p>
        <div class="splash-progress">
          <span id="splash-progress-text">Loading conversion engine...</span>
          <div class="progress-bar">
            <div id="progress-bar-inner" class="progress-bar-inner"></div>
          </div>
        </div>
        <p class="splash-credits">2025. Toolkit by e</p>
        <label class="splash-dont-show">
          <input type="checkbox" id="splash-dont-show-checkbox">
          Dont show again
        </label>
      </div>
      <div class="splash-image">
        <img src="modal.png" alt="Any2SVG Splash Image">
      </div>
    </div>
  </div>

  <div class="container loading" id="app-container">
    <header class="panel">
      <a href="../index.html" class="back-to-home" title="Return to Home">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </a>
      <h1>Any2SVG</h1>
      <div class="sub">Convert AI, PSD, PDF, and more to SVG.</div>
      <div class="theme-switcher">
        <button id="wiki-open-btn" title="Info">â“˜</button>
        <button id="theme-toggle" title="Change theme"></button>
      </div>
    </header>

    <aside class="panel controls" id="controls">
      <div class="control-group">
        <div class="form-group">
          <label for="fileInput">Source File</label>
          <input id="fileInput" class="form-control" type="file" accept="image/*,.ai,.psd,.pdf,.eps,.sketch,.xd,.cdr"
            disabled>
          <div id="fileMeta" class="note"
            style="border-top:none;padding-top:var(--space-2);font-size:var(--font-size-caption);"></div>
          <div id="engine-status-container">
            <div id="engine-status" class="note"
              style="border-top:none; padding-top:var(--space-2); font-size: var(--font-size-caption);"></div>
            <button id="reload-engine-btn" class="btn btn-secondary"
              style="display: none; margin-top: var(--space-3);">Reload Engine</button>
          </div>
        </div>
      </div>
      <div class="control-group" style="margin-top: auto;">
        <button id="convertBtn" class="btn btn-primary" disabled>Convert to SVG</button>
      </div>
      <div class="note">All files are processed locally in your browser for speed and privacy. No files are uploaded to
        any server.</div>
    </aside>

    <main class="panel" id="main-panel">
      <div class="placeholder" id="ph">The preview will appear here once you select a file.</div>
      <canvas id="preview" width="1" height="1" style="display:none"></canvas>
      <div id="toast-notification" class="toast-notification"></div>
    </main>
  </div>

  <div id="wiki-overlay" class="popup-overlay"></div>

  <iframe id="photopea" style="width:0;height:0;border:0;position:absolute;left:-9999px;top:-9999px"
    aria-hidden="true"></iframe>

  <script type="module">
    const WIKI_DATA = {
      "title": "Any2SVG Information",
      "sections": [
        {
          "title": "How to Use",
          "content": [
            "<b>1. Select a File:</b> Click the file input to select a supported file from your device (AI, PSD, PDF, etc.).",
            "<b>2. Preview:</b> A preview of your file will be generated.",
            "<b>3. Convert:</b> Click the 'Convert to SVG' button.",
            "<b>4. Download:</b> Your SVG will be automatically downloaded."
          ]
        },
        {
          "title": "Supported Files",
          "content": [
            "This tool supports a wide variety of file types, including:",
            "Adobe Illustrator (.ai)",
            "Adobe Photoshop (.psd)",
            "Portable Document Format (.pdf)",
            "And many other image formats."
          ]
        },
        {
          "title": "Privacy",
          "content": [
            "All file processing is done directly in your browser. Your files are never uploaded to a server, ensuring your privacy and data security."
          ]
        }
      ]
    };

    const App = {
      el: {},
      state: {
        engineReady: false,
        isOpening: false,
        isExpectingPreview: false,
        filenameBase: 'converted',
        splashHidden: false,
        toastTimeout: null
      },
      THEMES: ['light', 'dark', 'system'],
      THEME_ICONS: { light: 'â˜€ï¸', dark: 'ðŸŒ”', system: 'âš™ï¸' },
      isWikiLoaded: false,

      init() {
        this.cache();
        this.el.splashCloseBtn.disabled = true;
        this.initTheme();
        this.checkSplashPreference();
        this.bind();
        this.initVisitorCounter(); // === 2. LLAMAR A LA NUEVA FUNCIÃ“N ===

        this.loadEngine();

        window.addEventListener('message', (e) => this.onMessage(e));
        this.simulateLoading();
      },

      loadEngine() {
        const iframe = document.getElementById('photopea');
        const config = {
          script: "parent.postMessage('done','*')"
        };
        iframe.src = `https://www.photopea.com#${encodeURIComponent(JSON.stringify(config))}`;
        this.pp = iframe.contentWindow;
      },

      updateProgress(percentage, message) {
        if (this.el.progressBarInner) this.el.progressBarInner.style.width = `${percentage}%`;
        if (this.el.splashProgressText) this.el.splashProgressText.textContent = message;
      },

      simulateLoading() {
        this.updateProgress(10, 'Initializing engine...');
        setTimeout(() => {
          if (!this.state.engineReady) this.updateProgress(40, 'Loading assets...');
        }, 1500);
        setTimeout(() => {
          if (!this.state.engineReady) this.updateProgress(75, 'Configuring components...');
        }, 3000);

        setTimeout(() => {
          if (!this.state.engineReady) {
            this.updateProgress(100, 'Engine failed to load.');
            this.el.engineStatus.innerHTML = "<b>Engine failed to load.</b><br>Please disable ad blockers and click Reload.";
            this.el.engineStatus.classList.add('error-note');
            this.el.reloadEngineBtn.style.display = 'block';
            this.el.splashCloseBtn.disabled = false;
          }
        }, 15000);
      },

      hideSplashScreen(dontShowAgain = false) {
        if (!this.state.splashHidden) {
          this.state.splashHidden = true;
          this.el.splashScreen.classList.add('hidden');
          this.el.appContainer.classList.remove('loading');
          if (dontShowAgain) {
            localStorage.setItem('any2svg-splash-hidden', 'true');
          }
        }
      },

      checkSplashPreference() {
        if (localStorage.getItem('any2svg-splash-hidden') === 'true') {
          this.state.splashHidden = true;
          this.el.splashScreen.classList.add('hidden');
          this.el.appContainer.classList.remove('loading');
        }
      },

      cache() {
        const ids = [
          'theme-toggle', 'fileInput', 'convertBtn', 'fileMeta', 'main-panel', 'preview', 'ph',
          'wiki-open-btn', 'wiki-overlay', 'splash-screen', 'app-container', 'splash-close-btn',
          'splash-progress-text', 'progress-bar-inner', 'engine-status', 'reload-engine-btn',
          'toast-notification',
          'visitor-badge-container' // === 3. AÃ‘ADIR EL CONTENEDOR AL CACHÃ‰ ===
        ];
        ids.forEach(id => this.el[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())] = document.getElementById(id));
      },

      bind() {
        this.el.themeToggle.addEventListener('click', () => this.cycleTheme());
        this.el.fileInput.addEventListener('change', (e) => this.handleFilePick(e));
        this.el.convertBtn.addEventListener('click', () => this.convert());
        this.el.wikiOpenBtn.addEventListener('click', () => this.openWiki());
        this.el.splashScreen.addEventListener('click', (e) => {
          if (e.target === this.el.splashScreen && !this.el.splashCloseBtn.disabled) {
            this.hideSplashScreen();
          }
        });
        this.el.splashCloseBtn.addEventListener('click', () => { const cb = document.getElementById('splash-dont-show-checkbox'); this.hideSplashScreen(cb?.checked || false); });
        this.el.reloadEngineBtn.addEventListener('click', () => this.reloadEngine());
      },

      reloadEngine() {
        this.el.engineStatus.innerHTML = "Reloading engine...";
        this.el.engineStatus.classList.remove('error-note');
        this.el.reloadEngineBtn.style.display = 'none';

        this.loadEngine();

        this.state.engineReady = false;
        this.simulateLoading();
      },

      onMessage(e) {
        if (e.data === 'done') {
          if (!this.state.engineReady) {
            this.state.engineReady = true;
            this.updateProgress(100, 'Engine ready!');
            this.el.fileInput.disabled = false;
            this.el.splashCloseBtn.disabled = false;
            this.el.engineStatus.innerHTML = "";
            this.el.engineStatus.classList.remove('error-note');
            this.el.reloadEngineBtn.style.display = 'none';
            return;
          }
          if (this.state.isOpening) {
            this.state.isOpening = false;
            this.pp.postMessage('app.activeDocument.saveToOE("png");', '*');
          }
          return;
        }

        const msg = e.data;
        if (msg instanceof ArrayBuffer || (msg && msg.buffer instanceof ArrayBuffer)) {
          const ab = msg instanceof ArrayBuffer ? msg : msg.buffer.slice(msg.byteOffset, msg.byteLength);

          if (this.state.isExpectingPreview) {
            this.renderPreview(ab);
          } else {
            this.autoDownload(ab, this.state.filenameBase + '.svg', 'image/svg+xml');
          }
        }
      },

      initTheme() {
        const saved = localStorage.getItem('creative-toolkit-theme') || 'system';
        this.setTheme(saved, false);
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          if ((localStorage.getItem('creative-toolkit-theme') || 'system') === 'system') this.applyTheme('system');
        });
      },
      setTheme(t, save = true) {
        if (save) localStorage.setItem('creative-toolkit-theme', t);
        this.el.themeToggle.textContent = this.THEME_ICONS[t];
        this.applyTheme(t);
      },
      cycleTheme() {
        const cur = localStorage.getItem('creative-toolkit-theme') || 'system';
        const i = (this.THEMES.indexOf(cur) + 1) % this.THEMES.length;
        this.setTheme(this.THEMES[i]);
      },
      applyTheme(t) {
        const isDark = (t === 'system') ? window.matchMedia('(prefers-color-scheme: dark)').matches : t === 'dark';
        document.documentElement.dataset.theme = isDark ? 'dark' : 'light';
      },

      async handleFilePick(e) {
        const file = e.target.files && e.target.files[0];
        if (!file || !this.state.engineReady) return;

        this.resetState();
        this.el.ph.innerHTML = `
          <div class="loader-svg"></div>
          <div>Converting to SVG...</div>
        `;
        this.el.ph.style.display = 'flex';
        this.el.preview.style.display = 'none';

        this.state.filenameBase = file.name.replace(/\.[^.]+$/, '') || 'converted';
        this.el.fileMeta.textContent = `${file.name}, ${this.prettyBytes(file.size)}`;

        const buffer = await file.arrayBuffer();
        this.state.isOpening = true;
        this.state.isExpectingPreview = true;
        this.pp.postMessage(buffer, '*', [buffer]);
      },

      resetState() {
        this.state.isOpening = false;
        this.state.isExpectingPreview = false;
        this.el.convertBtn.disabled = true;
        this.el.convertBtn.textContent = 'Convert to SVG';
        this.el.ph.innerHTML = 'The preview will appear here once you select a file.';

        this.el.ph.style.display = 'flex';
        this.el.preview.style.display = 'none';
        this.el.fileMeta.textContent = '';
      },

      convert() {
        if (!this.state.engineReady) return;
        this.state.isExpectingPreview = false;
        this.el.convertBtn.disabled = true;
        this.el.convertBtn.textContent = 'Downloading...';
        this.pp.postMessage('app.activeDocument.saveToOE("svg");', '*');
      },

      renderPreview(ab) {
        const blob = new Blob([ab], { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          const panel = this.el.mainPanel.getBoundingClientRect();
          const maxW = panel.width - 40, maxH = panel.height - 40;
          const scale = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight, 1);
          const cw = Math.floor(img.naturalWidth * scale), ch = Math.floor(img.naturalHeight * scale);
          const cv = this.el.preview;
          cv.width = cw; cv.height = ch;
          const ctx = cv.getContext('2d');
          ctx.drawImage(img, 0, 0, cw, ch);
          this.el.ph.style.display = 'none';
          cv.style.display = 'block';

          this.el.convertBtn.textContent = 'Download SVG';
          this.el.convertBtn.disabled = false;

          this.showToast('Conversion Complete!');

          URL.revokeObjectURL(url);
        };
        img.src = url;
      },

      autoDownload(ab, filename, mime) {
        const blob = new Blob([ab], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href: url, download: filename });
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);

        this.resetState();
      },

      prettyBytes(n) {
        if (n < 1024) return n + ' B';
        const u = ['KB', 'MB', 'GB', 'TB']; let i = -1;
        do { n /= 1024; i++; } while (n >= 1024 && i < u.length - 1);
        return n.toFixed(1) + ' ' + u[i];
      },

      // === 4. AÃ‘ADIR NUEVA FUNCIÃ“N PARA EL CONTADOR ===
      initVisitorCounter() {
        if (!this.el.visitorBadgeContainer) return;

        const title = document.title; // "Any2SVG"
        const pagePath = title.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/--+/g, '-'); // "any2svg"
        const fullPath = `ealfaro29.toolkit.${pagePath}`; // "ealfaro29.toolkit.any2svg"

        let accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim().substring(1);
        if (!accentColor || accentColor.length < 6) {
          accentColor = 'A4C639'; // Fallback al color verde de esta app
        }

        const badgeUrl = `https://api.visitorbadge.io/api/visitors?path=${fullPath}&labelColor=%23555555&countColor=%23${accentColor}`;
        const linkUrl = `https://api.visitorbadge.io/api/visitors?path=${fullPath}`;

        this.el.visitorBadgeContainer.href = linkUrl;
        this.el.visitorBadgeContainer.innerHTML = `<img src="${badgeUrl}" alt="Visitor counter" />`;
      },

      showToast(message) {
        if (this.state.toastTimeout) {
          clearTimeout(this.state.toastTimeout);
        }
        this.el.toastNotification.textContent = message;
        this.el.toastNotification.classList.add('show');

        this.state.toastTimeout = setTimeout(() => {
          this.el.toastNotification.classList.remove('show');
          this.state.toastTimeout = null;
        }, 2500);
      },

      openWiki() {
        if (!this.el.wikiOverlay.querySelector('.wiki-modal-content')) {
          const wikiModal = document.createElement('div');
          wikiModal.className = 'wiki-modal-content';
          wikiModal.setAttribute('role', 'dialog');
          wikiModal.innerHTML = `<div class="wiki-header"><h3 id="wiki-title">Info</h3><button id="wiki-close-btn" title="Close">Ã—</button></div><div id="wiki-content"></div>`;
          this.el.wikiOverlay.appendChild(wikiModal);
          document.getElementById('wiki-close-btn').addEventListener('click', () => this.closeWiki());
        }

        if (!this.isWikiLoaded) {
          const titleEl = document.getElementById('wiki-title');
          const contentEl = document.getElementById('wiki-content');
          titleEl.textContent = WIKI_DATA.title;
          const col1 = document.createElement('div');
          col1.className = 'wiki-column';
          const col2 = document.createElement('div');
          col2.className = 'wiki-column';
          WIKI_DATA.sections.forEach((s, index) => {
            const sectionContainer = document.createElement('div');
            const h4 = document.createElement('h4');
            h4.textContent = s.title;
            sectionContainer.appendChild(h4);
            s.content.forEach(c => {
              const p = document.createElement('p');
              p.innerHTML = c;
              sectionContainer.appendChild(p);
            });
            if (index < 2) {
              col1.appendChild(sectionContainer);
            } else {
              col2.appendChild(sectionContainer);
            }
          });
          contentEl.innerHTML = '';
          contentEl.appendChild(col1);
          contentEl.appendChild(col2);
          this.isWikiLoaded = true;
        }
        this.el.wikiOverlay.classList.add('show');
      },
      closeWiki() {
        if (this.el.wikiOverlay) this.el.wikiOverlay.classList.remove('show');
      },
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>

  <a id="visitor-badge-container" class="floating-visitor-badge" href="https://api.visitorbadge.io" target="_blank"
    title="Visitor counter">
  </a>

</body>

</html>