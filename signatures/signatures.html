<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signature to SVG Converter</title>
  <script>
    (function() {
      try {
        let theme = localStorage.getItem('creative-toolkit-theme') || 'system';
        if (theme === 'system') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.dataset.theme = theme;
      } catch (e) {}
    })();
  </script>
  <style>
    :root {
      --accent-color: #002493; /* Nuevo Accent Color */
      --accent-color-tint: #b3c1e6; /* Tinte claro correspondiente */
      --color-text-primary-light: #1C1C1E; --color-text-secondary-light: #3A3A3C;
      --color-surface-light: #F5F5F7; --color-background-light: #FFFFFF;
      --color-divider-light: #EAEAEA; --color-text-primary-dark: #EAEAEB;
      --color-text-secondary-dark: #9A9A9E; --color-surface-dark: #121212;
      --color-background-dark: #1E1E1E; --color-divider-dark: #3A3A3C;
      --color-accent-text: #FFFFFF; --font-family-sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      --font-size-h1: 20px; --font-size-body: 14px; --font-size-caption: 12px;
      --font-weight-emphasis: 600; --font-weight-medium: 500;
      --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 24px;
      --radius-sm: 6px; --radius-md: 8px; --radius-xl: 16px;
      --shadow-raised-2: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-floating-3: 0 8px 20px rgba(0,0,0,0.12);
      --duration-standard: 200ms;
    }
    html[data-theme="light"] { --ink: var(--color-text-primary-light); --muted: var(--color-text-secondary-light); --surface: var(--color-surface-light); --surface-alt: var(--color-background-light); --border-color: var(--color-divider-light); --panel-shadow: var(--shadow-raised-2); color-scheme: light; }
    html[data-theme="dark"] { --ink: var(--color-text-primary-dark); --muted: var(--color-text-secondary-dark); --surface: var(--color-surface-dark); --surface-alt: var(--color-background-dark); --border-color: var(--color-divider-dark); --panel-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); color-scheme: dark; }

    html { box-sizing: border-box; } *, *:before, *:after { box-sizing: inherit; }
    body { margin: 0; color: var(--ink); background-color: var(--surface); font: var(--font-size-body)/1.5 var(--font-family-sans); padding: 25px; }

    .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 360px 1fr; grid-template-rows: auto 1fr; gap: 25px; height: calc(100vh - 50px); transition: filter 0.5s ease-in-out; }
    .container.loading { filter: blur(5px); pointer-events: none; }
    .panel { background: var(--surface-alt); border: 1px solid var(--border-color); border-radius: var(--radius-xl); box-shadow: var(--panel-shadow); }

    header.panel { grid-column: 1 / -1; height: 65px; display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4); }
    header h1 { font-size: var(--font-size-h1); font-weight: var(--font-weight-emphasis); margin: 0; }
    header .sub { color: var(--muted); }
    .theme-switcher { margin-left: auto; display: flex; align-items: center; gap: var(--space-2); }
    #theme-toggle, #wiki-open-btn { width: 36px; height: 36px; padding: 0; border-radius: 50%; background-color: var(--surface); color: var(--ink); border: 1px solid var(--border-color); font-size: 18px; display: grid; place-items: center; cursor: pointer; transition: all var(--duration-standard) ease; }
    #theme-toggle:hover, #wiki-open-btn:hover { background-color: var(--surface-alt); }
    .back-to-home { width: 36px; height: 36px; border-radius: 50%; background-color: var(--surface); color: var(--ink); border: 1px solid var(--border-color); display: grid; place-items: center; cursor: pointer; transition: all var(--duration-standard) ease; text-decoration: none; }
    .back-to-home:hover { background-color: var(--surface-alt); }
    .back-to-home svg { width: 18px; height: 18px; }

    aside.panel.controls { position: sticky; top: 0; max-height: 100%; overflow-y: auto; display: flex; flex-direction: column; gap: var(--space-5); padding: var(--space-5); }
    .control-group { display: flex; flex-direction: column; gap: var(--space-4); }
    .control-group + .control-group { border-top: 1px solid var(--border-color); padding-top: var(--space-5); }
    .note { font-size: var(--font-size-caption); color: var(--muted); border-top: 1px solid var(--border-color); padding-top: var(--space-4); }

    .btn { display: inline-flex; align-items: center; justify-content: center; width: 100%; cursor: pointer; font-weight: var(--font-weight-emphasis); font-size: 14px; border-radius: var(--radius-md); height: 40px; padding: 0 var(--space-4); border: 1px solid transparent; transition: all var(--duration-standard) ease; }
    .btn-primary { background-color: var(--accent-color); color: var(--color-accent-text); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background-color: var(--accent-color-tint); color: var(--accent-color); border-color: transparent; }
    .btn-secondary:hover { filter: brightness(0.95); }
    .btn:disabled { background-color: var(--surface); color: var(--muted); cursor: not-allowed; opacity: 0.6; }
    .btn:focus-visible, input:focus-visible, select:focus-visible, button:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; }
    
    .num-input { background: var(--surface); color: var(--ink); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 0 var(--space-3); height: 36px; width: 60px; text-align: right; }
    .num-input::-webkit-outer-spin-button, .num-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    
    .slider-row { display: flex; align-items: center; gap: var(--space-4); }
    .slider-row label { flex: 0 0 90px; font-weight: var(--font-weight-medium); }
    .slider-row input[type="range"] { flex: 1 1 auto; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; margin: 0; background: transparent; padding: 0; border: none; cursor: pointer; height: 16px; }
    input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: var(--surface); border-radius: 2px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 16px; width: 16px; background: var(--surface-alt); border-radius: 50%; border: 2px solid var(--accent-color); margin-top: -6px; }
    input[type="range"]::-moz-range-thumb { height: 16px; width: 16px; background: var(--surface-alt); border-radius: 50%; border: 2px solid var(--accent-color); }

    .checkbox-row { display: block; }
    .checkbox-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-weight: var(--font-weight-medium); }
    .checkbox-label input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .checkbox-custom { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: var(--radius-sm); transition: all var(--duration-standard) ease; }
    .checkbox-custom svg { width: 14px; height: 14px; stroke: var(--color-accent-text); stroke-width: 2.5; opacity: 0; transform: scale(0.5); transition: all var(--duration-standard) ease; }
    .checkbox-label input[type="checkbox"]:checked + .checkbox-custom { background-color: var(--accent-color); border-color: var(--accent-color); }
    .checkbox-label input[type="checkbox"]:checked + .checkbox-custom svg { opacity: 1; transform: scale(1); }
    .checkbox-label:hover .checkbox-custom { border-color: var(--accent-color); }
    .checkbox-label input[type="checkbox"]:focus-visible + .checkbox-custom { outline: 2px solid var(--accent-color); outline-offset: 2px; }

    main.panel { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-5); min-height: 0; gap: var(--space-5); height: 100%; }
    .image-viewer-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; gap: var(--space-4); position: relative; }
    .image-display-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 50%; border: 2px dashed var(--border-color); border-radius: var(--radius-md); padding: var(--space-3); overflow: hidden; position: relative; transition: border-color var(--duration-standard) ease; cursor: pointer; }
    #svg-output-wrapper:not(.empty) { cursor: default; }
    .image-display-wrapper.drag-over { border-color: var(--accent-color); background-color: var(--accent-color-tint); }
    .image-display-wrapper.empty p { color: var(--muted); text-align: center; padding: var(--space-4); }
    #uploaded-image-preview { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
    #svg-output-container { width: 100%; height: 100%; display: none; align-items: center; justify-content: center; overflow: hidden; }
    #svg-output-container svg { width: 100%; height: 100%; object-fit: contain; }

    #loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; width: 50px; height: 50px; border: 5px solid var(--accent-color-tint); border-top: 5px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; z-index: 10; background-color: var(--surface-alt); }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; }
    .popup-overlay.show { display: flex; align-items: center; justify-content: center; }
    .wiki-modal-content { background: var(--surface-alt); border-radius: var(--radius-xl); box-shadow: var(--shadow-floating-3); z-index: 2001; width: 800px; max-width: 90vw; max-height: 80vh; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
    .wiki-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-4); flex-shrink: 0; position: relative; height: 80px; color: white; background-image: url('modal.png'); background-size: cover; background-position: center bottom; }
    .wiki-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); z-index: 1; }
    .wiki-header h3, #wiki-close-btn { position: relative; z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
    #wiki-close-btn { background: none; border: none; font-size: 24px; line-height: 1; padding: 0; width: 36px; height: 36px; border-radius: 50%; color: var(--color-accent-text); cursor: pointer; transition: background-color 0.2s ease; }
    #wiki-close-btn:hover { background-color: rgba(255,255,255,0.1); }
    #wiki-content { padding: var(--space-5); overflow: hidden; flex-grow: 1; display: flex; gap: var(--space-5); }
    .wiki-column { flex: 1; min-width: 0; }
    #wiki-content h4 { margin-top: 0; margin-bottom: var(--space-3); font-weight: var(--font-weight-emphasis); color: var(--accent-color); }
    .dialog-content { width: 90%; max-width: 400px; padding: var(--space-5); text-align: center; }
    #dialog-message { margin: 0 0 var(--space-5); font-size: 16px; line-height: 1.6; }
    #dialog-actions { justify-content: center; display: flex; gap: var(--space-2); }
    #dialog-actions .btn { width: auto; min-width: 100px; }
    .splash-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.1); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); z-index: 9999; display: flex; justify-content: center; align-items: center; opacity: 1; transition: opacity 0.5s ease-out; cursor: pointer; }
    .splash-overlay.hidden { opacity: 0; pointer-events: none; }
    .splash-content { display: flex; width: 800px; height: 450px; max-width: 90vw; max-height: 80vh; background: var(--surface-alt); border-radius: var(--radius-md); box-shadow: var(--shadow-floating-3); overflow: hidden; cursor: default; position: relative; }
    #splash-close-btn { position: absolute; top: var(--space-3); right: var(--space-3); width: 32px; height: 32px; padding: 0; border-radius: 50%; background-color: var(--surface); color: var(--muted); border: 1px solid var(--border-color); font-size: 24px; line-height: 1; display: grid; place-items: center; cursor: pointer; transition: all 200ms ease; z-index: 10; }
    #splash-close-btn:hover { background-color: var(--surface-alt); color: var(--ink); transform: scale(1.1); }
    .splash-info { flex: 0 0 300px; padding: var(--space-5); display: flex; flex-direction: column; background-color: var(--surface-alt); color: var(--ink); border-left: 4px solid var(--accent-color); }
    .splash-icon { font-size: 32px; margin-bottom: var(--space-4); }
    .splash-title { font-size: 24px; font-weight: var(--font-weight-emphasis); color: var(--accent-color); margin-bottom: var(--space-5); }
    .splash-tech { margin: 0; color: var(--muted); line-height: 1.6; }
    .splash-credits { margin-top: auto; font-size: var(--font-size-caption); color: var(--muted); }
    .splash-image { flex: 1; background-color: var(--surface); }
    .splash-image img { width: 100%; height: 100%; object-fit: cover; }
    
    @media (max-width: 800px) {
        body { padding: var(--space-4); }
        .container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; height: auto; gap: var(--space-4); }
        aside.controls { position: static; max-height: none; }
        main.panel { min-height: 50vh; }
        .image-display-wrapper { height: 250px; }
        .splash-content { flex-direction: column; width: 90vw; height: auto; max-height: 90vh; }
        .splash-info { flex-basis: auto; border-left: none; border-top: 4px solid var(--accent-color); }
        .splash-image { width: 100%; height: 200px; }
        #wiki-content { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="splash-overlay" id="splash-screen">
    <div class="splash-content">
      <button id="splash-close-btn" title="Close">&times;</button>
      <div class="splash-info">
        <span class="splash-icon">✍️</span>
        <h2 class="splash-title">Signature to SVG</h2>
        <p class="splash-tech">Convert image signatures to vector graphics using a client-side Potrace implementation.</p>
        <p class="splash-credits">2025. Toolkit by e</p>
      </div>
      <div class="splash-image">
        <img src="modal.png" alt="Signature Splash Image">
      </div>
    </div>
  </div>

  <div class="container loading" id="app-container">
    <header class="panel">
      <a href="../index.html" class="back-to-home" title="Return to Home">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      </a>
      <h1>Signature to SVG</h1>
      <div class="sub">Convert image signatures to vector graphics.</div>
      <div class="theme-switcher">
        <button id="wiki-open-btn" title="Info">ⓘ</button>
        <button id="theme-toggle" title="Change theme"></button>
      </div>
    </header>

    <aside class="panel controls" id="controls">
      <div class="control-group">
          <h3>Conversion Settings</h3>
          <div class="slider-row">
              <label for="threshold">Threshold</label>
              <input id="threshold" type="range" min="0" max="255" value="128" step="1">
              <input class="num-input" id="threshold_num" type="number" min="0" max="255" step="1" value="128">
          </div>

          <div class="slider-row">
              <label for="turdsize">Denoise</label>
              <input id="turdsize" type="range" min="0" max="10" value="2" step="1">
              <input class="num-input" id="turdsize_num" type="number" min="0" max="10" step="1" value="2">
          </div>
          
          <div class="checkbox-row">
              <label class="checkbox-label" for="optcurve">
                  <span>Fit Curves</span>
                  <input type="checkbox" id="optcurve" checked>
                  <span class="checkbox-custom">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                      </svg>
                  </span>
              </label>
          </div>
      </div>

      <div class="control-group" style="margin-top: auto; border-top: none; padding-top: 0;">
        <button id="download-svg-btn" class="btn btn-primary" disabled>Download SVG</button>
      </div>
      
      <div class="note">Best results with sharp black signatures on white backgrounds. Threshold controls black/white detection. Denoise removes small imperfections.</div>
    </aside>

    <main class="panel" id="main-panel">
      <div class="image-viewer-container" id="image-viewer-container">
          <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
          <div id="original-image-wrapper" class="image-display-wrapper empty">
              <p id="placeholder-text-original">Original Image<br><br>Click or drag an image here,<br>or paste from clipboard (Ctrl+V)</p>
              <img id="uploaded-image-preview" src="#" alt="Signature Preview" style="display: none;">
          </div>
          <div id="svg-output-wrapper" class="image-display-wrapper empty">
              <p id="placeholder-text-svg">SVG Result</p>
              <div id="svg-output-container"></div>
          </div>
          <div id="loading-spinner"></div>
      </div>
    </main>
  </div>

  <div id="dialog-overlay" class="popup-overlay">
    <div class="dialog-content panel">
      <p id="dialog-message"></p>
      <div id="dialog-actions" class="btn-group"></div>
    </div>
  </div>

  <div id="wiki-overlay" class="popup-overlay"></div>

  <script src="potrace.js"></script>
  <script type="module">
    const WIKI_DATA = {
        "title": "Signature to SVG Info",
        "sections": [
            {
                "title": "How to Use",
                "content": [
                    "<b>1. Upload Your Image:</b> Click on the 'Original Image' area, drag and drop an image file onto it, or simply paste an image from your clipboard (Ctrl+V / Cmd+V). The conversion will start automatically.",
                    "<b>2. Adjust Settings:</b> Use the sliders for 'Threshold' and 'Denoise', and the 'Fit Curves' checkbox to fine-tune the SVG output:",
                    "  - <b>Threshold:</b> Controls the black/white binarization point. Adjust this to capture more or less detail from your signature.",
                    "  - <b>Denoise (Min Detail):</b> Suppresses small imperfections or 'speckles' in the output. Higher values remove more fine detail.",
                    "  - <b>Fit Curves:</b> Optimizes the paths to use smoother Bezier curves, making the SVG more fluid and less angular.",
                    "<b>3. Download SVG:</b> Once you are satisfied with the result, click the 'Download SVG' button at the bottom of the sidebar to save your vector signature."
                ]
            },
            {
                "title": "About SVG Signatures",
                "content": [
                    "An SVG (Scalable Vector Graphics) signature is a digital representation of a handwritten signature using vector paths instead of pixels. Unlike raster images (like JPEGs or PNGs) that become blurry when scaled up, SVGs remain crisp and clear at any size.",
                    "This makes SVG signatures ideal for high-resolution documents, digital forms, and any application where visual quality and scalability are crucial."
                ]
            }
        ]
    };

    const App = {
      el: {},
      state: {
        imageSrc: null,
        svgOutput: null,
        isLoading: false,
        splashHidden: false,
        isWikiLoaded: false,
        potraceParameters: {
          threshold: 128,
          turdsize: 2,
          optcurve: true,
          turnpolicy: "minority",
          alphamax: 1,
          opttolerance: 0.2
        }
      },
      THEMES: ['light', 'dark', 'system'],
      THEME_ICONS: { light: '☀️', dark: '🌔', system: '⚙️' },

      init() {
        this.cacheDOMElements();
        this.initTheme();
        this.loadState();
        this.bindEvents();
        this.render();
      },

      hideSplashScreen() {
          if (!this.state.splashHidden) {
              this.state.splashHidden = true;
              this.el.splashScreen.classList.add('hidden');
              this.el.appContainer.classList.remove('loading');
          }
      },

      cacheDOMElements() {
        const ids = [
          'theme-toggle', 'wiki-open-btn', 'wiki-overlay', 'download-svg-btn', 
          'hidden-file-input', 'uploaded-image-preview', 'svg-output-container', 
          'loading-spinner', 'placeholder-text-original', 'placeholder-text-svg', 
          'original-image-wrapper', 'svg-output-wrapper', 'threshold', 'threshold_num',
          'turdsize', 'turdsize_num', 'optcurve',
          'splash-screen', 'app-container', 'splash-close-btn',
          'dialog-overlay', 'dialog-message', 'dialog-actions'
        ];
        ids.forEach(id => {
          const key = id.replace(/[-_](\w)/g, (_, char) => char.toUpperCase());
          this.el[key] = document.getElementById(id);
        });
      },

      bindEvents() {
        this.el.themeToggle.addEventListener('click', () => this.cycleTheme());
        this.el.wikiOpenBtn.addEventListener('click', () => this.openWiki());
        this.el.splashScreen.addEventListener('click', (e) => {
            if (e.target === this.el.splashScreen) this.hideSplashScreen();
        });
        this.el.splashCloseBtn.addEventListener('click', () => this.hideSplashScreen());

        this.el.downloadSvgBtn.addEventListener('click', () => this.downloadSvg());

        this.el.originalImageWrapper.addEventListener('click', () => this.el.hiddenFileInput.click());
        this.el.hiddenFileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));

        this.el.threshold.addEventListener('input', (e) => this.updateParameter('threshold', parseInt(e.target.value, 10)));
        this.el.thresholdNum.addEventListener('change', (e) => this.updateParameter('threshold', parseInt(e.target.value, 10)));
        this.el.turdsize.addEventListener('input', (e) => this.updateParameter('turdsize', parseInt(e.target.value, 10)));
        this.el.turdsizeNum.addEventListener('change', (e) => this.updateParameter('turdsize', parseInt(e.target.value, 10)));
        this.el.optcurve.addEventListener('change', (e) => this.updateParameter('optcurve', e.target.checked));

        const dropZone = this.el.originalImageWrapper;
        dropZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', e => { e.stopPropagation(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', e => {
          e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over');
          if (e.dataTransfer.files.length > 0) this.handleFileSelect(e.dataTransfer.files);
        });

        document.body.addEventListener('paste', e => {
          for (const item of e.clipboardData.items) {
            if (item.type.includes('image')) {
              const file = item.getAsFile();
              if (file) { this.handleFileSelect([file]); return; }
            }
          }
        });
      },

      saveAndRender() { this.saveState(); this.render(); },
      
      saveState() {
          localStorage.setItem('signatureParams_v1', JSON.stringify(this.state.potraceParameters));
      },
      
      loadState() {
        const savedParams = localStorage.getItem('signatureParams_v1');
        if (savedParams) {
          try {
            Object.assign(this.state.potraceParameters, JSON.parse(savedParams));
          } catch(e) {
            console.error("Could not load saved parameters.", e);
            localStorage.removeItem('signatureParams_v1');
          }
        }
        this.el.threshold.value = this.state.potraceParameters.threshold;
        this.el.thresholdNum.value = this.state.potraceParameters.threshold;
        this.el.turdsize.value = this.state.potraceParameters.turdsize;
        this.el.turdsizeNum.value = this.state.potraceParameters.turdsize;
        this.el.optcurve.checked = this.state.potraceParameters.optcurve;
      },

      updateParameter(key, value) {
        if (key === 'threshold') value = Math.max(0, Math.min(255, value));
        if (key === 'turdsize') value = Math.max(0, Math.min(10, value));

        this.state.potraceParameters[key] = value;
        
        if (key === 'threshold') { this.el.threshold.value = value; this.el.thresholdNum.value = value; }
        if (key === 'turdsize') { this.el.turdsize.value = value; this.el.turdsizeNum.value = value; }
        if (key === 'optcurve') this.el.optcurve.checked = value;

        if (this.state.imageSrc && !this.state.isLoading) this.processImage();
        this.saveState();
      },

      handleFileSelect(files) {
        const file = files[0];
        if (file && file.type.startsWith('image/')) {
          this.state.svgOutput = null;
          const reader = new FileReader();
          reader.onload = e => {
            this.state.imageSrc = e.target.result;
            this.render();
            this.processImage(file);
          };
          reader.readAsDataURL(file);
        } else {
          if (file) this.showAlert("Please upload a valid image file.");
          this.state.imageSrc = null;
          this.state.svgOutput = null;
          this.render();
        }
        this.el.hiddenFileInput.value = '';
      },

      async processImage(file) {
        if (!this.state.imageSrc) return;
        this.state.isLoading = true; this.state.svgOutput = null; this.render();
        try {
          Potrace.loadImageFromUrl(this.state.imageSrc);
          Potrace.setParameter(this.state.potraceParameters);
          await new Promise(resolve => {
            Potrace.process(() => {
              const rawSvg = Potrace.getSVG(1);
              const { width, height } = Potrace.img;
              const parser = new DOMParser();
              const svgDoc = parser.parseFromString(rawSvg, "image/svg+xml");
              const svgElement = svgDoc.documentElement;
              svgElement.setAttribute('viewBox', `0 0 ${width} ${height}`);
              svgElement.setAttribute('width', '100%');
              svgElement.setAttribute('height', '100%');
              svgElement.removeAttribute('style');
              this.state.svgOutput = new XMLSerializer().serializeToString(svgElement);
              resolve();
            });
          });
        } catch (error) {
          console.error("Error processing image:", error);
          this.state.svgOutput = `<p style="color: var(--muted); text-align: center;">Error converting image. Try adjusting settings. Error: ${error.message}</p>`;
          this.showAlert("Error generating SVG!");
        } finally {
          this.state.isLoading = false; this.render();
        }
      },

      downloadSvg() {
        if (!this.state.svgOutput) return;
        const blob = new Blob([this.state.svgOutput], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = 'signature.svg';
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 0);
      },

      render() {
        this.el.loadingSpinner.style.display = this.state.isLoading ? 'block' : 'none';
        this.el.downloadSvgBtn.disabled = !this.state.svgOutput || this.state.isLoading;

        if (this.state.imageSrc) {
            this.el.uploadedImagePreview.src = this.state.imageSrc;
            this.el.uploadedImagePreview.style.display = 'block';
            this.el.placeholderTextOriginal.style.display = 'none';
            this.el.originalImageWrapper.classList.remove('empty');
            this.el.originalImageWrapper.style.cursor = 'default';
        } else {
            this.el.uploadedImagePreview.style.display = 'none';
            this.el.placeholderTextOriginal.style.display = 'block';
            this.el.originalImageWrapper.classList.add('empty');
            this.el.originalImageWrapper.style.cursor = 'pointer';
        }

        if (this.state.svgOutput) {
            this.el.svgOutputContainer.innerHTML = this.state.svgOutput;
            this.el.svgOutputContainer.style.display = 'flex';
            this.el.placeholderTextSvg.style.display = 'none';
            this.el.svgOutputWrapper.classList.remove('empty');
        } else {
            this.el.svgOutputContainer.innerHTML = '';
            this.el.svgOutputContainer.style.display = 'none';
            this.el.placeholderTextSvg.style.display = 'block';
            this.el.svgOutputWrapper.classList.add('empty');
        }
      },
      
      showDialog(message, { buttons = [], onConfirm = () => {} } = {}) {
          this.el.dialogMessage.textContent = message;
          this.el.dialogActions.innerHTML = '';
          buttons.forEach(buttonInfo => {
              const button = document.createElement('button');
              button.className = `btn ${buttonInfo.class || 'btn-secondary'}`;
              button.textContent = buttonInfo.text;
              button.dataset.action = buttonInfo.action || 'cancel';
              this.el.dialogActions.appendChild(button);
          });
          const actionHandler = (e) => {
              if (e.target.dataset.action === 'confirm') onConfirm();
              this.hideDialog();
              this.el.dialogActions.removeEventListener('click', actionHandler);
          };
          this.el.dialogActions.addEventListener('click', actionHandler);
          this.el.dialogOverlay.classList.add('show');
      },
      hideDialog() { this.el.dialogOverlay.classList.remove('show'); },
      showAlert(message) {
          this.showDialog(message, { buttons: [{ text: 'OK', class: 'btn-primary', action: 'confirm' }] });
      },

      initTheme() { /* ... */ },
      setTheme(theme, save = true) { /* ... */ },
      cycleTheme() { /* ... */ },
      applyTheme(theme) { /* ... */ },
      openWiki() { /* ... */ },
      closeWiki() { /* ... */ },
    };
    
    // Rellenar las funciones omitidas con el código completo de notes.html
    App.initTheme = function() {
        const savedTheme = localStorage.getItem('creative-toolkit-theme') || 'system';
        this.setTheme(savedTheme, false);
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          if (localStorage.getItem('creative-toolkit-theme') === 'system') this.applyTheme('system');
        });
    };
    App.setTheme = function(theme, save = true) {
        if (save) localStorage.setItem('creative-toolkit-theme', theme);
        this.el.themeToggle.textContent = this.THEME_ICONS[theme];
        this.applyTheme(theme);
    };
    App.cycleTheme = function() {
        const currentTheme = localStorage.getItem('creative-toolkit-theme') || 'system';
        this.setTheme(this.THEMES[(this.THEMES.indexOf(currentTheme) + 1) % this.THEMES.length]);
    };
    App.applyTheme = function(theme) {
        const isDark = (theme === 'system') ? window.matchMedia('(prefers-color-scheme: dark)').matches : theme === 'dark';
        document.documentElement.dataset.theme = isDark ? 'dark' : 'light';
    };
    App.openWiki = function() {
        if (!this.el.wikiOverlay.querySelector('.wiki-modal-content')) {
            const wikiModal = document.createElement('div');
            wikiModal.className = 'wiki-modal-content';
            wikiModal.innerHTML = `<div class="wiki-header"><h3 id="wiki-title">Info</h3><button id="wiki-close-btn" title="Close">×</button></div><div id="wiki-content"></div>`;
            this.el.wikiOverlay.appendChild(wikiModal);
            wikiModal.querySelector('#wiki-close-btn').addEventListener('click', () => this.closeWiki());
        }
        if (!this.isWikiLoaded) {
            const titleEl = this.el.wikiOverlay.querySelector('#wiki-title');
            const contentEl = this.el.wikiOverlay.querySelector('#wiki-content');
            titleEl.textContent = WIKI_DATA.title;
            const col1 = document.createElement('div'); col1.className = 'wiki-column';
            const col2 = document.createElement('div'); col2.className = 'wiki-column';
            WIKI_DATA.sections.forEach((s, index) => {
                const sectionContainer = document.createElement('div');
                const h4 = document.createElement('h4'); h4.textContent = s.title;
                sectionContainer.appendChild(h4);
                s.content.forEach(c => { const p = document.createElement('p'); p.innerHTML = c; sectionContainer.appendChild(p); });
                if (index < Math.ceil(WIKI_DATA.sections.length / 2)) {
                    col1.appendChild(sectionContainer);
                } else {
                    col2.appendChild(sectionContainer);
                }
            });
            contentEl.innerHTML = '';
            contentEl.appendChild(col1);
            contentEl.appendChild(col2);
            this.isWikiLoaded = true;
        }
        this.el.wikiOverlay.classList.add('show');
    };
    App.closeWiki = function() {
        this.el.wikiOverlay.classList.remove('show');
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>